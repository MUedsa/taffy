
import com.muedsa.taffy.ResponseValidator;
import com.muedsa.taffy.TaffyAuthRequestFactory;
import com.muedsa.taffy.http.TaffyHttpClientFactory;
import com.muedsa.taffy.utils.*;
import emu.grasscutter.net.proto.QueryRegionListHttpRspOuterClass;
import org.junit.jupiter.api.Test;

import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.util.Base64;
import java.util.HexFormat;

public class MhyCryptoTest {

    private static final byte[] SECRET_KEY = HexFormat.of().parseHex("A15408F45FBDFFDF97418E1DD75830A9408CDAC95DF91D25CFFD285828438E13F942D35B4B5327ABA8E923E3669EFB810A462399F2BCDCD0A22BD23A5C9B34D48DE29B8D83A377B4D744471D7C25568182A8749866B703F2AF7FF1754C27CA3243EDF034FFDB44C242DDF3B5F62FD74A288191004FC9BC35951C2E3EE14B8ACEFF509175476D85E4759E5B8A16031AEE66323504E17C75366732DD49E701255DC9EEB2A460CD8E3348AE9097B54B1399491182026807D85EBD4FB98AE7D6C647FD5E2A9102E3B5CDBF91A9CCECE3D7A46B2DC5483D4A863DDA98E198C01ABFC36F19BCA4CD3FCF00F287665EAC2552CD3E898B9D61C2A064BDFF468AF1799D3F840C55582F5056622F860FCE5A18C71D5DED3FA6BACD56E065D399E18585684AF138C99E76EB4A178E476B708887FED326CF9F9C2F43FF185A29BDFDED916DD752FF2DCA75A919B9CFA38B68528F5FA4AE6B0762CB7B79ACBB9A9243D76F3E49FF8D9BFAD00943C3AF9D5B5E46891F1CE97A7FAFE115F848929DEADE47CA3307AC9EA0879E82FCFC3A4FCEBD0F4B7DB3D7DE8FA28BAAB4E19946932F2D93E6F1CF7517EA674035D3B74FDC1F593DE21FCDCBBBF40C7C1F4AD253E80B8B203509386AEB94D8EB56C4CFFF68E64A5ACBD559C75DBD3020F169F0F762CB862E11DE80173010952E623056F973825FF403054660E9ADD2C79045D2C22C7B32C6842B1F743A0D17D8BC79C041CA3FABD92DAEDDFD255FE767D33A44B63EFAE9BACED9878A53C82BA57D5A664CDDAC046CEEF89D62F0E222A4743D90EB4C0CEB7A6242ABDF84B7F8A7E3AF75CCB0CE38633DE684F966582F6C3B42C65BE37A0A24D158CAE7122A28D038472739F74F39F7377D8605623C0D5E52038021B2D627FB9FC801678CEFEEB6BC606D261863A7533E71037ED3AB25C51DA073268A71A3A1EF0EA50AA5731F080B9A27148E86AA6E5724FB8BD9235A5E3036DBA0DB4201523B0C4FE7F378F9381552A985B966027AF8F4415DCEC03B348ACF6D3E6300D7601C6EC0157E054083AB6421A111650D299F7EEACE29B1932846C0954AE23EB6068A01C678DA52CF50654E6950394782DFBB8D91FA475BFDBF246C26B9943AA99B37382A1CA8DB5B2620816ECDCEC052BF646012CBB3258BC66A7D117DA3A823A89454C86C39C2A8FD1FC0817E879A0292679D14581FC5407E3166E1D15AF54ECA5BAB5F3BB2D032904AEDD7C21B7381D2CF2B59C3B3B6F51A36A45B65D1F300CB71380F638A8528CE01E09282166FAF6ACF5E560D825A19E8E212B8BB3F53502CF7D4E1FF09C379CD821E3BFBA5F52E5B471D262FA4FB17B3749D78034ADE1DAE41B1755227D09B6B9709B06757878BC19B640A67882B87F0F712162BA9216F96D65BFAE10D9766AAB5F99DE521F7F0612A4D3F8518A13AFB4E70DEE1049FA23FE61CF202AEC42CBE4BD409FCDCE94632CC7CAF8A77499F5BD939549F33EDE594A227483382201A89A652ED33F2070AD9DD3693803E808A408C63008F649C5A9D92F8044A7BD1794066152EDE5C116AF320EFA54D990C22A897E93FA40C1D827486F518994BA7228F658711E42A089F78318DC9973A037E3BD567DF2F98084B323F8A27827BEA0C35BB1BDB4B6F1AD3ADE39AB2AC1488C30A64CAF83CAAC079CDA320B235ED3709811C1E0D278EF1FF1260BC65B6E766A274F1D09F06332F8760F564BC2AF165083CFE87D955DFD40D80F6F376E2D8CB89388E0719BD2319CBF732FE317641D73B9C76F09E826AE55B9D70C01D4313A905486544633C0C0A646678A3DA3E95C2588E38A7F85496F2AA563091339AF233E1C946EF7434170C747DF5E25D3BC8A2A346F750835E992E61185A326BE4CB37995577F125BE7058F3CEBD5B349BF53896F4651601235C7E59A38EF686E653BC826E524EF9A9270A7E4AADD27C7E60395E2CC0299FB8DF242CC37430E4933B7F06CDC1A54922ED57C4700C77C187AE87EFD15C4CF3D0C52D148D20C725437DC40BD508E31F45818020ADF68D611CEE8939085EC36E5E3F813B946FE64A39FF4EDA6B6094FC259E8363FB3CAD7DFD80C699C454995A39D3E6A0B7F221DA57EEF63AB207D367D98C627EACB0A9092AB8E5C4AC6369722C94CE684D669642B75F260E7A5E9F1AE58CCB443B3884CBC604D08A4EE4BB056773F2072F5ED121FE82947D7F47F12B4D8FFEF6AFACEA8EFB299A212F785415D17A7CCB4A0B2D8076DF61B3E859C160972A19470DCD6C79AAA8B75FB18ED9712ABD04FD2625A5924711B0D112DE6F574231EA9EEE2B7DEC033396FD5E416C75DA2E8E44E279E29B269713CE7F0A9DDC06ED6D3106AEE0395BE9C24CAB2F07605CF0AB7B8E28166F4499594AF6AC84C1D29DE8C4E7EF4E34AA6EC01EEC50D615859B616BC23E230B677C0BD8AE9695988D2770D1CC68AF41A1C83F7BAF0331C1EB4C47005BBB60292D7BCA445AA0E0EFA9C4331D85E6BEF09275D2F2BB26F1F18E356FEAFB2D462F7898B691B9BAF69657A2D83738068661D6591D95A5DE13EADD9E53D4C11870B634E727E3E4A7001B4EBFD03B1C45C55D08946FEBEC5206C281B066D703AB0E1DD8B3501D488173C013F3C83407A3189075EDF10A7EE0CE4C9A8C4C47D019EF1601B13724904359831867343A665F602EFFBBBEF0B1FE22E8D5B62AA1D62923F167A163DC3F94AA00DC4E2CBFBBAB3FA1DD3A916451C10B46434F3AADEB1035BEEF1288E4CA3E522F170F9BE9EF80ADAF0241EA686F8265342278369593B2430D08EEE5D47EC0268073F50130084B68541F6475A608BCCD3A4177DC41B73A2D0F6957A783A79F79EDEFC734056315B7840986976741E28EBAEF2089314991A66D35ECD6FBACF56D36F68414CE8251C6002809C6BE47D2CCAB26475442DB382E83B2F61637674FC9D4E74249C95306D389D6045BF559235AACD9F2C430498A19A0BBF33B6ECA849DE14A7068BE9E9628B4C17F04B51BD707D0501246A9C697F82058AC8A4014B1C9F3DFBDD410AAEBDCC2D30871013460E07CD43844A1AEE505AE7CFBD314C9DDBB5B539A141F4B839A275A49E0C1454BD55CE8F687D25FD341E038557F51805FDA3AF48B3E89852B067E378E6733B8D9BC3EC2572CFDBE334325D8FABF73699268280A47B62FD7F48930332821D86DB3415C432B2B4A3A3E8632433D395D0907C6F8492A01EE11801020537DD7AEC14A528CE126FFFE3DBF2A26B5DF0C03518E0D0152191827CCBE7110DECE94D1EB73573CED9CBD74B75CDFBB2D7B54568D6B5A8EC458A2F27F68A5F591C32F7F0DB838A584218A40E6145BFAD6B206F2B0F886DF4E2424ABA9FB7BA85B0C1BAE3BF0D833AB7A02C9DCDF21246CC326D18DBF2183E2A9F2889A394B5E49F734F3341DB0BC4B46E5A67109A207D8993750A1A7901891D490E90677A451197A3D95EB122C115CB37D9FD7EF972FFCA03C2260D82EF2A60A83ECC555BF7193FC5C480B8BC1E762D3FB421F65B34D54A1AFF35701EB53A43C1CC5F9F66107C8F00D3E1316E24D23996786E2012D117143DE7CDBAF42F40477CD54B20265387A04564DC24364079B31EBA45142A53286E87DCF9BE6A183989582147491289CB55731A3D89C3385E0DDD72067939F0134FD0EEB172540BFB1089CF5A9A045092C186680D455D20C1BAD6ACCFE1E87952FCE7A31F7EC1B5300ED15EBFB722631091B803166FB2D7CFFFE96F31C03AB18B21363553E0786E68B57C81E66AFFAC4A39EB756B40355DE78D21ED62FE7B954736CACF455ADF5381F4F3D4FEAD2CC9A3DFE00244C7D3F2522F7BA2B42F03274C734519DB1F507B7C5B4F4C7AADFEC4D7ABB3ACB620C48A3350959739BE836C121E43FDA7BFF9784C9F2D3F1E10E21B11DE74187A6CE15699966042962CFD689DD8ECB4064FDC58E66952B04B2053B4AF0BB8061C4429D56C4DCA00DCAA0399310BB9E3CEBB49DC297497CA73D7813E28EC27636FF953E38BEDB87A53489BD67A7FC583AA9E6B9F0C5865D05A365E270068209CB64DED44E15A7D90004E1719E71B743BA5BFD3DB56CCC253A4C5E8224450761D7D93E928580A3F28078DA277A89A38D91E94875B43AB76F55C3F4CC57515F70150619D6159566BA1D02ACBBA556536590DEEF327AB5C71CA9B62288C7C7D0C8DCD30641CEEBC1B4A071D40E71DC64ABA24F90E1F3F04FEB82407DECB0ED371974AD21A1E2EAF732748F741BB49AEA8758D32D4EF14F017208788A3B31883E1ED73A77253D4FC31099017673B0BBBBD5BFD4828038DF00BB2CF646FAF6A9D7F1F5E5BAFBD2490184D9870DF97EBAC04503FA0B7C39AF45EA26D5A4978116E15FC88C230DE8ED5C936AD028EC6FA41A44405D35402E6F35D723269AE5BDC88726A57D80B9BD899C2D926BEFEB7772AA31FD28D3F0632E2432A9E21AD3CFE3085C2CF2FFE32C8D2E9C9FB772EBB020BAC9649B8FB8DF7110E8410639FA8DD3FCA3F142B93BDA140A57C7DE63949E491AFDAA295C06F71D9DCA9BDBB3F8B88140AAA65249DAEB3D52C35FCD116437E84A9C7210D611896741ED7767F0DB9F91C1170900EB5AA631DFE02516B251FE9002D02E0E4636FBCCDC60D1EAD08955C98B1BEE4DE54CFAF5B6A3F1CC4D65E41A3CE05049210B56D981EE77D2709BD6698C1ADBD61F4126CD3D427E47FFC2BEB7B3119F61A93087EDD116BF7480C4D095204D89AE4B0EF7DE259CA99799A0137223F8236D0D00E0FAD1B32477E99965EDC64E5E9D17160FF45041E3FE9A979ED64D13B974AF84C5561155001464CE21161230F425DAB6AAC7A1C354F25DFFCBCAE42F5325AFEE7BFF6EF863D14F7610307A9F8CB366BA91BBBBC12FEC7A097512B55E1C796819E278913BEE2A47CDBC423554A0B9BFA30EAF0E466550208EDF14AAEB8770E870980E149ACCBFAAE42CF28369CD5C256386886646839481FF021ADE05DF4C68BEC62DD63C5FCC7B8B90F444EE8A837BCD7DD40777A7B199BE243C3326F77195AAB71E0148D1FCEA07CDD52508685DE919809F645C96B97F8E23406BB25B335BFB5618E7D9C28BA0103673989F03FB7803E4B8A5F4AB2E1113342C663B6270EAB77C11C274E729BF1A5753263640F9D4AA9A84AA30C85771E8557888B3727C012A5FC1CEEE8CC11CEF9C25BA5BD8957FC0B6BAB716C3F5B9561CDF078FE977F36D6905FC255BC57CE6D3E14DE6C1EE4EC44A57857553DCC9964212390794CCC8C20C60687DD8A134951380D1B5D4DE4DF73C8460F852160C7B6A86337B1164D6A355B6B9A2B41C8FE7D8211B9B14D29A044050BE92F77DBE104FAD2C1DC4BFCC12D0BD3B59D46A629547FFFD7162370B41B7EC9689466D9D121E6146B824D8FC4BAB7A886CFBB205F30DC3994B32FF63DACA9471F5C09C0AE48646A4FC1E7FB6F39310143010DF70CA7805F350659C737D9649D4FF58E224D939A16F4037EAAC014F924A54A4FDF412ECEC2345AD3AA9EF258088D574A7CF1F393FED394CC474DAA4E7805C9D6CD1B95AA2DE9C28BCD9D8C4A0F3771535DA63FD3C7F982D1AEB00B150FF6269DA1DF253ADF5C13117AB228C4682A71305540B57DBE69F0CBDB58E427EB73B257FB931202D4A89BC72625DE5C72987B5BF71BE4E47A3BFF3494AA432407AE83EC591974B9A7D2C4F7AF0BD4C53D7C2E1E143B7101298515BE6A7BA809BFFAB4EB37DE1AA5BBBB91E9133B5535F3345634002F7135C4F6A9A83ACA29DB843EE0C7F886628ACBE00E537B6DB44BC1DB0B76938594EB256D0D0190333A0AF1B6AD2458CA6");

    private static final long SECRET_KEY_SEED = Long.parseUnsignedLong("11468049314633205968");

    @Test
    public void generateKeyTest(){
        byte[] generateKey = MhyCrypto.generateXorKey(SECRET_KEY_SEED);
        for (int i = 0; i < SECRET_KEY.length; i++) {
            assert generateKey[i] == SECRET_KEY[i];
        }
    }

    @Test
    public void dispatchConfigTest() throws IOException {
        String base64RegionListResponse = TaffyAuthRequestFactory.queryRegionList("https://127.0.0.1",
                        "CNRELWin1.0.0", 1, 1, 0)
                .execute(TaffyHttpClientFactory.create("", true))
                .returnContent().asString(StandardCharsets.UTF_8);
        QueryRegionListHttpRspOuterClass.QueryRegionListHttpRsp queryRegionListHttpRsp = QueryRegionListHttpRspOuterClass
                .QueryRegionListHttpRsp
                .parseFrom(Base64.getDecoder().decode(base64RegionListResponse.getBytes(StandardCharsets.UTF_8)));
        System.out.println("queryRegionListHttpRsp:{}\n" + JsonUtils.protobufToString(queryRegionListHttpRsp));
        ResponseValidator.valid(queryRegionListHttpRsp.getRetcode());
        byte[] clientSecretKeyBytes = queryRegionListHttpRsp.getClientSecretKey().toByteArray();
        byte[] clientCustomConfigBytes = queryRegionListHttpRsp.getClientCustomConfigEncrypted().toByteArray();
        byte[] keyBytes = new byte[16];
        byte[] dataBytes = new byte[2048];
        System.out.println("clientSecretKey:\n" + HexFormatUtils.beautify(clientSecretKeyBytes));
        System.arraycopy(clientSecretKeyBytes, 8, keyBytes, 0, 16);
        System.arraycopy(clientSecretKeyBytes, 28, dataBytes, 0, 2048);
        System.out.println("key:\n" + HexFormatUtils.beautify(keyBytes));
        System.out.println("data:\n" + HexFormatUtils.beautify(dataBytes));
        long seed = MhyCrypto.getSeed(keyBytes, dataBytes);
        MhyCrypto.xor(clientCustomConfigBytes, MhyCrypto.generateEc2bXorKey(seed));
        System.out.println(new String(clientCustomConfigBytes, StandardCharsets.UTF_8));
    }
}
